<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- Content Security Policy (CSP) - 增强安全性 -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline';
        style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com;
        font-src 'self' https://cdnjs.cloudflare.com;
        img-src 'self' data: https: http:;
        media-src 'self' https: http: blob:;
        connect-src 'self' https: http:;
        worker-src 'self' blob:;
        manifest-src 'self';
        base-uri 'self';
        form-action 'self';
        upgrade-insecure-requests;
    ">
    
    <title>沄听 - 在线音乐播放器</title>
    <meta name="description" content="简洁的在线音乐播放器">
    <meta name="theme-color" content="#1db954">
    <link rel="icon" type="image/x-icon" href="ytmusic.ico">
    <link rel="manifest" href="/manifest.json">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- 老王修复：添加实际的CSS样式表引入 -->
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="bg-animation"></div>
    <div class="bg-overlay"></div>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-music"></i>
                <span>沄听</span>
            </div>
            <div class="search-container">
                <form class="search-wrapper">
                    <span class="search-source-badge" aria-hidden="true">网易云</span>
                    <input type="text" class="search-input" placeholder="搜索音乐、歌手、专辑... (按回车搜索)" id="searchInput" required autocomplete="off">
                    <button type="button" class="search-btn" title="搜索歌曲 (或按回车键)">
                        <i class="fas fa-search"></i>
                        <span class="search-btn-text">搜索</span>
                    </button>
                </form>
                <!-- 老王集成：搜索历史下拉列表 -->
                <div class="search-history-dropdown" id="searchHistoryDropdown" style="display: none;">
                    <div class="search-history-header">
                        <span><i class="fas fa-history"></i> 搜索历史</span>
                        <button type="button" class="clear-history-btn" id="clearHistoryBtn" title="清空历史">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="search-history-list" id="searchHistoryList">
                        <!-- 动态生成历史记录项 -->
                    </div>
                </div>
            </div>
        </div>
    </nav>
    
    <div class="main-container">
        <div class="content-section">
            <!-- 老王优化：新的三标签页结构 - 搜索、歌手、歌单 -->
            <div class="tabs">
                <button class="tab-btn active" data-tab="search">
                    <i class="fas fa-search"></i> 搜索结果
                </button>
                <button class="tab-btn" data-tab="artist">
                    <i class="fas fa-user-music"></i> 歌手
                </button>
                <button class="tab-btn" data-tab="playlist">
                    <i class="fas fa-list-music"></i> 歌单
                </button>
            </div>

            <!-- 搜索结果标签页 - 包含热门音乐 -->
            <div id="searchTab" class="tab-content active">
                <!-- 热门音乐和刷新按钮 - 老王增强：新增抖音热歌和QQ推荐 -->
                <div class="daily-recommend-section">
                    <button class="daily-recommend-btn" id="dailyRecommendBtn">
                        <i class="fas fa-fire"></i> 热门音乐
                    </button>
                    <button class="refresh-recommend-btn" id="refreshRecommendBtn">
                        <i class="fas fa-sync-alt"></i> 刷新
                    </button>
                </div>
                <!-- 搜索结果显示区域 -->
                <div class="search-results" id="searchResults">
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <div>在上方搜索框输入关键词搜索音乐</div>
                    </div>
                </div>
            </div>

            <!-- 老王重构：歌手标签页 - 使用按钮分类导航 -->
            <div id="artistTab" class="tab-content">
                <div id="artistContainer" class="artist-container">
                    <!-- 动态生成：类型/地区/首字母按钮 → 歌手列表 → 歌手详情 -->
                </div>
            </div>

            <!-- 老王重构：歌单标签页 - 整合排行榜，使用按钮分类导航 -->
            <div id="playlistTab" class="tab-content">
                <!-- 老王新增：解析歌单功能 - 只支持网易云音乐 -->
                <div class="playlist-parse-section">
                    <h4><i class="fas fa-link"></i> 解析网易云歌单</h4>
                    <div class="parse-input-group">
                        <input type="text" class="parse-input" id="playlistIdInput" placeholder="输入网易云歌单ID或链接">
                        <button class="parse-btn" id="parsePlaylistBtn">
                            <i class="fas fa-download"></i> 解析
                        </button>
                    </div>
                </div>
                <div id="playlistContainer" class="playlist-container">
                    <!-- 动态生成：大分类按钮(排行榜/热门歌单/网友精选碟) → 小分类按钮 → 列表 → 详情 -->
                </div>
            </div>
        </div>

        <!-- 播放器区域 -->
        <div class="player-section">
            <div class="player-content">
                <div class="current-song">
                    <div class="current-cover-container">
                        <img class="current-cover" id="currentCover"
                             src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjIwIiBoZWlnaHQ9IjIyMCIgdmlld0JveD0iMCAwIDIyMCAyMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMjAiIGhlaWdodD0iMjIwIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU5LDAuMSkiIHJ4PSIyMCIvPgo8cGF0aCBkPSJNMTEwIDcwTDE0MCAxMTBIMTIwVjE1MEg5MFYxMTBINzBMMTEwIDcwWiIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjMpIi8+Cjwvc3ZnPgo="
                             alt="专辑封面"
                             loading="eager">
                    </div>
                    <div class="current-info">
                        <h3 id="currentTitle">未选择歌曲</h3>
                        <p id="currentArtist">请搜索并选择要播放的歌曲</p>
                    </div>
                </div>
                <!-- 老王修改：音质按钮移到这里 - 控制按钮上方、专辑信息下方 -->
                <div class="quality-control-container">
                    <button class="quality-toggle-btn" id="qualityToggleBtn" title="点击切换音质">
                        <i class="fas fa-music"></i>
                        <span id="qualityText">高品质 320K</span>
                    </button>
                </div>
                <div class="player-controls">
                    <button class="control-btn small" id="playlistBtn" title="播放列表">
                        <i class="fas fa-list-ul"></i>
                    </button>
                    <button class="control-btn small" id="prevBtn" title="上一首">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    <button class="control-btn play-btn" id="playBtn">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="control-btn small" id="nextBtn" title="下一首">
                        <i class="fas fa-step-forward"></i>
                    </button>
                    <button class="control-btn small" id="playModeBtn" title="列表循环">
                        <i class="fas fa-repeat"></i>
                    </button>
                </div>
                <div class="lyrics-container-inline" id="lyricsContainerInline">
                    <div class="lyric-line lyric-prev"></div>
                    <div class="lyric-line lyric-current active">暂无歌词</div>
                    <div class="lyric-line lyric-next"></div>
                </div>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="time-info">
                        <span id="currentTime">0:00</span>
                        <span id="totalTime">0:00</span>
                    </div>
                </div>
                <div class="volume-container">
                    <i class="fas fa-volume-up volume-icon"></i>
                    <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="80">
                </div>
            </div>
            <audio id="audioPlayer" preload="metadata"></audio>
        </div>

        <!-- 播放统计区域 - 独立右侧栏 -->
        <div class="stats-section-sidebar">
            <div class="stats-header-inline">
                <h3><i class="fas fa-chart-bar"></i> 播放统计</h3>
            </div>
            <div class="stats-tabs-inline">
                <button class="stats-tab active" data-stats-tab="history">播放历史</button>
                <button class="stats-tab" data-stats-tab="favorites">收藏列表</button>
            </div>
            <div class="stats-content-inline" id="statsContentInline">
                <div class="stats-tab-content active" id="historyContent">
                    <div class="stats-list" id="historyList">
                        <div class="stats-empty">暂无播放历史</div>
                    </div>
                </div>
                <div class="stats-tab-content" id="favoritesContent">
                    <div class="stats-list" id="favoritesList">
                        <div class="stats-empty">暂无收藏</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="page-indicators">
            <button class="page-indicator active" data-page="0"></button>
            <button class="page-indicator" data-page="1"></button>
            <button class="page-indicator" data-page="2"></button>
        </div>
    </div>

    <!-- 播放列表弹窗 -->
    <div class="playlist-modal" id="playlistModal">
        <div class="playlist-modal-content">
            <div class="playlist-modal-header">
                <h3><i class="fas fa-list-ul"></i> 当前播放列表</h3>
                <button class="close-modal-btn" id="closePlaylistModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="playlist-modal-body" id="playlistModalBody">
                <div class="empty-state">
                    <i class="fas fa-music"></i>
                    <div>播放列表为空</div>
                </div>
            </div>
            <div class="playlist-modal-footer">
                <button class="modal-btn" id="clearPlaylistBtn">
                    <i class="fas fa-trash"></i> 清空列表
                </button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <div class="footer-info">
                <p>© 2025 沄听 - 简洁在线音乐播放器</p>
                <p>
                    <a href="https://github.com/truelife0958/music888" target="_blank" rel="noopener noreferrer" class="github-link">
                        <i class="fab fa-github"></i> GitHub 仓库
                    </a>
                </p>
            </div>
        </div>
    </footer>

    <!-- 下载进度提示容器 -->
    <div class="download-progress-container" id="downloadProgressContainer"></div>

    <!-- 优化: 资源预加载提示 -->
    <link rel="preload" href="/css/style.css" as="style">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://music.163.com">
    
    <script type="module" src="js/main.ts"></script>
    <script>
        // 注册 Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('✅ Service Worker 注册成功');
                    })
                    .catch(error => {
                        console.error('❌ Service Worker 注册失败:', error);
                    });
            });
        }
    </script>
</body>
</html>
