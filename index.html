<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- Content Security Policy (CSP) - 增强安全性 -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline';
        style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com;
        font-src 'self' https://cdnjs.cloudflare.com;
        img-src 'self' data: https: http:;
        media-src 'self' https: http: blob:;
        connect-src 'self' https: http:;
        worker-src 'self' blob:;
        manifest-src 'self';
        base-uri 'self';
        form-action 'self';
        upgrade-insecure-requests;
    ">
    
    <title>沄听 - 在线音乐播放器</title>
    <meta name="description" content="简洁的在线音乐播放器">
    <meta name="theme-color" content="#1db954">
    <link rel="icon" type="image/x-icon" href="ytmusic.ico">
    <link rel="manifest" href="/manifest.json">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- 老王修复：添加实际的CSS样式表引入 -->
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="bg-animation"></div>
    <div class="bg-overlay"></div>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-music"></i>
                <span>沄听</span>
            </div>
            <div class="search-container">
                <form class="search-wrapper">
                    <input type="text" class="search-input" placeholder="搜索音乐、歌手、专辑..." id="searchInput" required>
                    <select class="source-select" id="sourceSelect">
                        <option value="netease">网易云音乐</option>
                        <option value="tencent">QQ音乐</option>
                        <option value="kugou">酷狗音乐</option>
                        <option value="kuwo">酷我音乐</option>
                    </select>
                    <button type="submit" class="search-btn">
                        <i class="fas fa-search"></i>
                    </button>
                </form>
            </div>
            <div class="nav-actions">
                <button class="nav-btn" id="apiSettingsBtn" title="API设置">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>
    </nav>
    
    <div class="main-container">
        <div class="content-section">
            <!-- 老王优化：新的三标签页结构 - 搜索、歌手、歌单 -->
            <div class="tabs">
                <button class="tab-btn active" data-tab="search">
                    <i class="fas fa-search"></i> 搜索结果
                </button>
                <button class="tab-btn" data-tab="artist">
                    <i class="fas fa-user-music"></i> 歌手
                </button>
                <button class="tab-btn" data-tab="playlist">
                    <i class="fas fa-list-music"></i> 歌单
                </button>
            </div>

            <!-- 搜索结果标签页 - 包含每日推荐和刷新推荐 -->
            <div id="searchTab" class="tab-content active">
                <!-- 每日推荐和刷新按钮 -->
                <div class="daily-recommend-section">
                    <button class="daily-recommend-btn" id="dailyRecommendBtn">
                        <i class="fas fa-calendar-day"></i> 每日推荐
                    </button>
                    <button class="refresh-recommend-btn" id="refreshRecommendBtn">
                        <i class="fas fa-sync-alt"></i> 刷新推荐
                    </button>
                </div>
                <!-- 搜索结果显示区域 -->
                <div class="search-results" id="searchResults">
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <div>在上方搜索框输入关键词搜索音乐</div>
                    </div>
                </div>
            </div>

            <!-- 老王重构：歌手标签页 - 使用按钮分类导航 -->
            <div id="artistTab" class="tab-content">
                <div id="artistContainer" class="artist-container">
                    <!-- 动态生成：类型/地区/首字母按钮 → 歌手列表 → 歌手详情 -->
                </div>
            </div>

            <!-- 老王重构：歌单标签页 - 整合排行榜，使用按钮分类导航 -->
            <div id="playlistTab" class="tab-content">
                <div id="playlistContainer" class="playlist-container">
                    <!-- 动态生成：大分类按钮(排行榜/热门歌单/网友精选碟) → 小分类按钮 → 列表 → 详情 -->
                </div>
            </div>
        </div>

        <!-- 播放器区域 -->
        <div class="player-section">
            <div class="player-content">
                <div class="current-song">
                    <div class="current-cover-container">
                        <img class="current-cover" id="currentCover"
                             src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjIwIiBoZWlnaHQ9IjIyMCIgdmlld0JveD0iMCAwIDIyMCAyMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMjAiIGhlaWdodD0iMjIwIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU5LDAuMSkiIHJ4PSIyMCIvPgo8cGF0aCBkPSJNMTEwIDcwTDE0MCAxMTBIMTIwVjE1MEg5MFYxMTBINzBMMTEwIDcwWiIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjMpIi8+Cjwvc3ZnPgo="
                             alt="专辑封面"
                             loading="eager">
                    </div>
                    <div class="current-info">
                        <h3 id="currentTitle">未选择歌曲</h3>
                        <p id="currentArtist">请搜索并选择要播放的歌曲</p>
                    </div>
                </div>
                <div class="player-controls">
                    <button class="control-btn small" id="playlistBtn" title="播放列表">
                        <i class="fas fa-list-ul"></i>
                    </button>
                    <button class="control-btn small" id="prevBtn" title="上一首">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    <button class="control-btn play-btn" id="playBtn">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="control-btn small" id="nextBtn" title="下一首">
                        <i class="fas fa-step-forward"></i>
                    </button>
                    <button class="control-btn small" id="playModeBtn" title="列表循环">
                        <i class="fas fa-repeat"></i>
                    </button>
                </div>
                <div class="lyrics-container-inline" id="lyricsContainerInline">
                    <div class="lyrics-header-inline">
                        <button class="lyrics-download-btn" id="lyricsDownloadBtn" disabled title="下载当前歌词">
                            <i class="fas fa-download"></i>
                            <span>下载歌词</span>
                        </button>
                    </div>
                    <div class="lyric-line lyric-prev"></div>
                    <div class="lyric-line lyric-current active">暂无歌词</div>
                    <div class="lyric-line lyric-next"></div>
                </div>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="time-info">
                        <span id="currentTime">0:00</span>
                        <span id="totalTime">0:00</span>
                    </div>
                </div>
                <div class="volume-container">
                    <i class="fas fa-volume-up volume-icon"></i>
                    <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="80">
                </div>
                <div class="quality-control-container">
                    <button class="quality-toggle-btn" id="qualityToggleBtn" title="点击切换音质">
                        <i class="fas fa-music"></i>
                        <span id="qualityText">高品质 320K</span>
                    </button>
                </div>
            </div>
            <audio id="audioPlayer" preload="metadata"></audio>
        </div>

        <!-- 播放统计区域 - 独立右侧栏 -->
        <div class="stats-section-sidebar">
            <div class="stats-header-inline">
                <h3><i class="fas fa-chart-bar"></i> 播放统计</h3>
            </div>
            <div class="stats-tabs-inline">
                <button class="stats-tab active" data-stats-tab="history">播放历史</button>
                <button class="stats-tab" data-stats-tab="favorites">收藏列表</button>
            </div>
            <div class="stats-content-inline" id="statsContentInline">
                <div class="stats-tab-content active" id="historyContent">
                    <div class="stats-list" id="historyList">
                        <div class="stats-empty">暂无播放历史</div>
                    </div>
                </div>
                <div class="stats-tab-content" id="favoritesContent">
                    <div class="stats-list" id="favoritesList">
                        <div class="stats-empty">暂无收藏</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="page-indicators">
            <button class="page-indicator active" data-page="0"></button>
            <button class="page-indicator" data-page="1"></button>
            <button class="page-indicator" data-page="2"></button>
        </div>
    </div>

    <!-- 播放列表弹窗 -->
    <div class="playlist-modal" id="playlistModal">
        <div class="playlist-modal-content">
            <div class="playlist-modal-header">
                <h3><i class="fas fa-list-ul"></i> 当前播放列表</h3>
                <button class="close-modal-btn" id="closePlaylistModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="playlist-modal-body" id="playlistModalBody">
                <div class="empty-state">
                    <i class="fas fa-music"></i>
                    <div>播放列表为空</div>
                </div>
            </div>
            <div class="playlist-modal-footer">
                <button class="modal-btn" id="clearPlaylistBtn">
                    <i class="fas fa-trash"></i> 清空列表
                </button>
            </div>
        </div>
    </div>

    <!-- API设置弹窗 -->
    <div class="api-settings-modal" id="apiSettingsModal">
        <div class="api-settings-modal-content">
            <div class="api-settings-modal-header">
                <h3><i class="fas fa-cog"></i> API设置</h3>
                <button class="close-modal-btn" id="closeApiSettingsModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="api-settings-modal-body">
                <div class="api-setting-section">
                    <h4>当前API状态</h4>
                    <div class="api-status-info" id="apiStatusInfo">
                        <div class="api-status-item">
                            <span class="api-status-label">当前API源:</span>
                            <span class="api-status-value" id="currentApiName">加载中...</span>
                        </div>
                        <div class="api-status-item">
                            <span class="api-status-label">API地址:</span>
                            <span class="api-status-value api-url" id="currentApiUrl">加载中...</span>
                        </div>
                        <div class="api-status-item">
                            <span class="api-status-label">功能支持:</span>
                            <div class="api-capabilities" id="apiCapabilities">
                                <span class="capability-badge">检测中...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="api-setting-section">
                    <h4>切换API源</h4>
                    <p class="api-hint">
                        <i class="fas fa-info-circle"></i>
                        不同API源支持的功能不同，推荐使用NCM增强API获得完整功能
                    </p>
                    <div class="api-source-list" id="apiSourceList">
                        <!-- API源列表将动态生成 -->
                    </div>
                </div>

                <div class="api-setting-section">
                    <h4>功能说明</h4>
                    <div class="api-feature-explanation">
                        <div class="feature-item">
                            <i class="fas fa-check-circle" style="color: #4ecdc4;"></i>
                            <div>
                                <strong>NCM增强API</strong>
                                <p>支持热门歌单、歌手分类、网友精选碟等完整功能</p>
                            </div>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-exclamation-circle" style="color: #ffa502;"></i>
                            <div>
                                <strong>GDStudio API</strong>
                                <p>支持基础搜索和播放，使用内置推荐数据作为降级方案</p>
                            </div>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-info-circle" style="color: #95afc0;"></i>
                            <div>
                                <strong>Meting API</strong>
                                <p>支持基础搜索和播放，使用内置推荐数据作为降级方案</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="api-settings-modal-footer">
                <button class="modal-btn secondary" id="testAllApisBtn">
                    <i class="fas fa-sync-alt"></i> 测试所有API
                </button>
                <button class="modal-btn" id="closeApiSettingsModalFooter">
                    关闭
                </button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <div class="footer-info">
                <p>© 2025 沄听 - 简洁在线音乐播放器</p>
                <p>
                    <a href="https://github.com/truelife0958/music888" target="_blank" rel="noopener noreferrer" class="github-link">
                        <i class="fab fa-github"></i> GitHub 仓库
                    </a>
                </p>
            </div>
        </div>
    </footer>

    <!-- 下载进度提示容器 -->
    <div class="download-progress-container" id="downloadProgressContainer"></div>

    <!-- 优化: 资源预加载提示 -->
    <link rel="preload" href="/css/style.css" as="style">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://music.163.com">
    
    <script type="module" src="js/main.ts"></script>
    <script>
        // 注册 Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('✅ Service Worker 注册成功');
                    })
                    .catch(error => {
                        console.error('❌ Service Worker 注册失败:', error);
                    });
            });
        }
    </script>
</body>
</html>
