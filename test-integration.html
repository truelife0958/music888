<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³æºé›†æˆæµ‹è¯• - Music888</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 32px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .test-input {
            width: 70%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .test-btn {
            padding: 10px 20px;
            margin-left: 10px;
            background: #1db954;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .test-btn:hover {
            background: #1aa34a;
        }
        .test-results {
            margin-top: 16px;
            padding: 16px;
            background: #f8f8f8;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
        }
        .result-item {
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .status-success { color: #1db954; }
        .status-error { color: #ff4444; }
        .status-info { color: #ff8800; }
        .loading { color: #666; font-style: italic; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸµ Music888 éŸ³æºé›†æˆæµ‹è¯•</h1>
        <p>æµ‹è¯• Listen1 Chrome Extension å¤šå¹³å°æ¶æ„çš„é›†æˆæƒ…å†µ</p>

        <div class="test-section">
            <h3>ğŸ” æœç´¢æµ‹è¯•</h3>
            <div>
                <input type="text" id="searchInput" class="test-input" placeholder="è¾“å…¥æœç´¢å…³é”®è¯ï¼ˆå¦‚ï¼šå‘¨æ°ä¼¦ï¼‰" value="å‘¨æ°ä¼¦">
                <button id="searchBtn" class="test-btn">æµ‹è¯•æœç´¢</button>
                <select id="searchSource" class="test-input" style="width: 150px; margin-left: 10px;">
                    <option value="auto">æ™ºèƒ½é€‰æ‹©</option>
                    <option value="listen1">Listen1 å…¨å¹³å°</option>
                    <option value="enhanced">å¢å¼ºç‰ˆå¤šå¹³å°</option>
                    <option value="netease">ç½‘æ˜“äº‘éŸ³ä¹</option>
                    <option value="qq">QQéŸ³ä¹</option>
                </select>
            </div>
            <div id="searchResults" class="test-results">ç­‰å¾…æµ‹è¯•...</div>
        </div>

        <div class="test-section">
            <h3>ğŸ§ æ’­æ”¾URLæµ‹è¯•</h3>
            <p>ç‚¹å‡»æœç´¢ç»“æœä¸­çš„æ­Œæ›²ï¼Œæµ‹è¯•æ’­æ”¾é“¾æ¥è·å–</p>
            <div id="playUrlResults" class="test-results">ç­‰å¾…é€‰æ‹©æ­Œæ›²...</div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ æ­Œè¯æµ‹è¯•</h3>
            <p>è‡ªåŠ¨æµ‹è¯•æœç´¢æ­Œæ›²çš„æ­Œè¯è·å–</p>
            <div id="lyricResults" class="test-results">ç­‰å¾…é€‰æ‹©æ­Œæ›²...</div>
        </div>

        <div class="test-section">
            <h3>âš™ï¸ ç³»ç»ŸçŠ¶æ€</h3>
            <button id="statusBtn" class="test-btn">æ£€æŸ¥ç³»ç»ŸçŠ¶æ€</button>
            <div id="statusResults" class="test-results">ç‚¹å‡»æŒ‰é’®æ£€æŸ¥çŠ¶æ€...</div>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª ç»¼åˆæµ‹è¯•</h3>
            <button id="fullTestBtn" class="test-btn">è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶</button>
            <div id="fullTestResults" class="test-results">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
        </div>
    </div>

    <script type="module">
        // å¯¼å…¥æµ‹è¯•æ¨¡å—
        import { sourceTester } from '/js/source-tester.js';
        import { enhancedSearch } from '/js/enhanced-search.js';
        import { unifiedProviderManager } from '/js/providers/unified-provider-manager.js';

        let currentSongs = [];

        // æœç´¢æµ‹è¯•
        document.getElementById('searchBtn').addEventListener('click', async () => {
            const keyword = document.getElementById('searchInput').value;
            const source = document.getElementById('searchSource').value;
            const resultsDiv = document.getElementById('searchResults');

            resultsDiv.innerHTML = '<div class="loading">ğŸ” æœç´¢ä¸­...</div>';

            try {
                const startTime = Date.now();
                const result = await enhancedSearch.search({
                    keyword,
                    source,
                    type: 0,
                    limit: 10
                });
                const duration = Date.now() - startTime;

                currentSongs = result.songs;

                let html = `<div class="status-success">âœ… æœç´¢æˆåŠŸ (${result.fromSource}, ${duration}ms) - æ‰¾åˆ° ${result.songs.length} é¦–æ­Œæ›²</div>`;

                result.songs.slice(0, 5).forEach((song, index) => {
                    html += `
                        <div class="result-item">
                            <strong>${index + 1}. ${song.name}</strong><br>
                            æ­Œæ‰‹: ${song.artist?.[0] || 'æœªçŸ¥'}<br>
                            ä¸“è¾‘: ${song.album || 'æœªçŸ¥'}<br>
                            æ¥æº: ${song.source}<br>
                            <button onclick="testSong(${index})" style="margin-top: 8px; padding: 4px 8px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">æµ‹è¯•è¿™é¦–æ­Œ</button>
                        </div>
                    `;
                });

                resultsDiv.innerHTML = html;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status-error">âŒ æœç´¢å¤±è´¥: ${error.message}</div>`;
            }
        });

        // æµ‹è¯•å•é¦–æ­Œæ›²
        window.testSong = async (index) => {
            const song = currentSongs[index];
            if (!song) return;

            // æµ‹è¯•æ’­æ”¾URL
            const playUrlDiv = document.getElementById('playUrlResults');
            playUrlDiv.innerHTML = '<div class="loading">ğŸ§ è·å–æ’­æ”¾é“¾æ¥...</div>';

            try {
                const playResult = await enhancedSearch.getPlayUrl(song);
                if (playResult.url) {
                    playUrlDiv.innerHTML = `
                        <div class="status-success">âœ… æ’­æ”¾é“¾æ¥è·å–æˆåŠŸ (${playResult.fromSource})</div>
                        <div class="result-item">
                            <strong>${song.name}</strong><br>
                            URL: ${playResult.url.substring(0, 100)}...<br>
                            æ¥æº: ${playResult.fromSource}
                        </div>
                    `;
                } else {
                    playUrlDiv.innerHTML = `<div class="status-error">âŒ æ— æ³•è·å–æ’­æ”¾é“¾æ¥</div>`;
                }
            } catch (error) {
                playUrlDiv.innerHTML = `<div class="status-error">âŒ æ’­æ”¾é“¾æ¥è·å–å¤±è´¥: ${error.message}</div>`;
            }

            // æµ‹è¯•æ­Œè¯
            const lyricDiv = document.getElementById('lyricResults');
            lyricDiv.innerHTML = '<div class="loading">ğŸ“ è·å–æ­Œè¯...</div>';

            try {
                const lyricResult = await enhancedSearch.getLyric(song);
                if (lyricResult.lyric) {
                    lyricDiv.innerHTML = `
                        <div class="status-success">âœ… æ­Œè¯è·å–æˆåŠŸ (${lyricResult.fromSource})</div>
                        <div class="result-item">
                            <strong>${song.name}</strong><br>
                            <pre style="max-height: 150px; overflow-y: auto; background: white; padding: 8px; border-radius: 4px;">${lyricResult.lyric.substring(0, 500)}${lyricResult.lyric.length > 500 ? '...' : ''}</pre>
                            æ¥æº: ${lyricResult.fromSource}
                        </div>
                    `;
                } else {
                    lyricDiv.innerHTML = `<div class="status-error">âŒ æ— æ³•è·å–æ­Œè¯</div>`;
                }
            } catch (error) {
                lyricDiv.innerHTML = `<div class="status-error">âŒ æ­Œè¯è·å–å¤±è´¥: ${error.message}</div>`;
            }
        };

        // ç³»ç»ŸçŠ¶æ€æ£€æŸ¥
        document.getElementById('statusBtn').addEventListener('click', () => {
            const statusDiv = document.getElementById('statusResults');

            try {
                const systemStatus = unifiedProviderManager.getSystemStatus();
                const platforms = unifiedProviderManager.getAllPlatforms();
                const searchStats = enhancedSearch.getSearchStats();

                let html = `
                    <div class="status-success">âœ… ç³»ç»ŸçŠ¶æ€æ­£å¸¸</div>
                    <div class="result-item">
                        <strong>ç³»ç»ŸçŠ¶æ€:</strong><br>
                        ${JSON.stringify(systemStatus, null, 2)}
                    </div>
                    <div class="result-item">
                        <strong>æ”¯æŒå¹³å° (${platforms.length}ä¸ª):</strong><br>
                        ${platforms.map(p => `${p.name} (${p.source})`).join(', ')}
                    </div>
                    <div class="result-item">
                        <strong>æœç´¢ç»Ÿè®¡:</strong><br>
                        ${JSON.stringify(searchStats, null, 2)}
                    </div>
                `;

                statusDiv.innerHTML = html;
            } catch (error) {
                statusDiv.innerHTML = `<div class="status-error">âŒ çŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
            }
        });

        // å®Œæ•´æµ‹è¯•å¥—ä»¶
        document.getElementById('fullTestBtn').addEventListener('click', async () => {
            const resultsDiv = document.getElementById('fullTestResults');
            resultsDiv.innerHTML = '<div class="loading">ğŸ§ª è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶...</div>';

            try {
                await sourceTester.runFullTest();
                await sourceTester.testSystemStatus();

                resultsDiv.innerHTML = `
                    <div class="status-success">âœ… å®Œæ•´æµ‹è¯•å¥—ä»¶æ‰§è¡Œå®Œæˆ</div>
                    <div class="result-item">
                        <strong>æµ‹è¯•ç»“æœ:</strong><br>
                        è¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°çš„è¯¦ç»†è¾“å‡º
                    </div>
                    <div class="status-info">ğŸ’¡ æ‰“å¼€å¼€å‘è€…å·¥å…·æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†æµ‹è¯•ç»“æœ</div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status-error">âŒ æµ‹è¯•å¥—ä»¶æ‰§è¡Œå¤±è´¥: ${error.message}</div>`;
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆæç¤º
        console.log('ğŸµ Music888 éŸ³æºé›†æˆæµ‹è¯•é¡µé¢å·²åŠ è½½');
        console.log('ğŸ’¡ å¯ä»¥ç›´æ¥è°ƒç”¨ enhancedSearch, unifiedProviderManager ç­‰å¯¹è±¡è¿›è¡Œæµ‹è¯•');
    </script>
</body>
</html>