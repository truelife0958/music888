# å•å…ƒæµ‹è¯•å®æ–½è®¡åˆ’

## å½“å‰çŠ¶æ€

### æµ‹è¯•æ¡†æ¶é…ç½®
- **æµ‹è¯•æ¡†æ¶**: Vitest 2.1.0
- **æµ‹è¯•ç¯å¢ƒ**: happy-dom
- **è¦†ç›–ç‡å·¥å…·**: @vitest/coverage-v8
- **æµ‹è¯•æ–‡ä»¶ä½ç½®**: `tests/` ç›®å½•
- **æµ‹è¯•æ–‡ä»¶å‘½å**: `*.spec.ts` æˆ– `*.test.ts`

### å·²åˆ›å»ºçš„æµ‹è¯•æ–‡ä»¶
1. `tests/config.spec.ts` - é…ç½®å¸¸é‡æµ‹è¯•
2. `tests/utils.spec.ts` - å·¥å…·å‡½æ•°æµ‹è¯•ï¼ˆ375è¡Œï¼Œ58ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
3. `tests/setup.ts` - æµ‹è¯•ç¯å¢ƒè®¾ç½®

### æµ‹è¯•è¦†ç›–çš„æ¨¡å—
- âœ… `js/config.ts` - é…ç½®éªŒè¯æµ‹è¯•
- âœ… `js/utils.ts` - å®Œæ•´çš„å·¥å…·å‡½æ•°æµ‹è¯•
  - é˜²æŠ–å’ŒèŠ‚æµå‡½æ•°
  - æ—¶é—´æ ¼å¼åŒ–
  - JSON è§£æ
  - LocalStorage æ“ä½œ
  - é”™è¯¯å¤„ç†
  - è‰ºæœ¯å®¶ä¿¡æ¯æ ¼å¼åŒ–
  - æ–‡ä»¶åç”Ÿæˆ
  - HTML æ¸²æŸ“å‡½æ•°

## é‡åˆ°çš„æŠ€æœ¯é—®é¢˜

### "No test suite found" é”™è¯¯
**é—®é¢˜æè¿°**: Vitest æ— æ³•è¯†åˆ«æµ‹è¯•æ–‡ä»¶ä¸­çš„æµ‹è¯•å¥—ä»¶

**å°è¯•çš„è§£å†³æ–¹æ¡ˆ**:
1. âœ… å®‰è£…è¦†ç›–ç‡ä¾èµ– `@vitest/coverage-v8`
2. âœ… æ›´æ–° `tsconfig.json` åŒ…å« tests ç›®å½•
3. âœ… å°è¯•ä¸åŒçš„ vitest é…ç½®ï¼ˆglobalsã€include ç­‰ï¼‰
4. âœ… é™çº§ vitest ä» 4.x åˆ° 2.x ç‰ˆæœ¬
5. âœ… ä½¿ç”¨ `.spec.ts` ä»£æ›¿ `.test.ts` æ‰©å±•å

**å½“å‰çŠ¶æ€**: é—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œå¯èƒ½ä¸é¡¹ç›®çš„æ¨¡å—è§£æé…ç½®æœ‰å…³

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨è®¡åˆ’

### çŸ­æœŸç›®æ ‡ï¼ˆç«‹å³æ‰§è¡Œï¼‰

#### 1. æµ‹è¯•æ¡†æ¶è¯Šæ–­
```bash
# æ£€æŸ¥ vitest ç‰ˆæœ¬å…¼å®¹æ€§
npx vitest --version

# å°è¯•æœ€å°åŒ–é…ç½®è¿è¡Œæµ‹è¯•
npx vitest run --no-coverage

# æ£€æŸ¥ TypeScript ç¼–è¯‘
npx tsc --noEmit
```

#### 2. æ›¿ä»£æ–¹æ¡ˆ
å¦‚æœ Vitest é—®é¢˜æŒç»­ï¼Œè€ƒè™‘:
- ä½¿ç”¨ Jest ä½œä¸ºæµ‹è¯•æ¡†æ¶
- å°†æµ‹è¯•æ–‡ä»¶ç§»åˆ° `js/__tests__/` ç›®å½•
- ä½¿ç”¨ Vite çš„å†…ç½®æµ‹è¯•æ”¯æŒ

### ä¸­æœŸç›®æ ‡ï¼ˆ1-2å¤©ï¼‰

#### 3. å®Œæˆæ ¸å¿ƒæ¨¡å—æµ‹è¯•
ä¼˜å…ˆçº§é¡ºåºï¼š
1. **é«˜ä¼˜å…ˆçº§** (æ ¸å¿ƒåŠŸèƒ½)
   - `js/player.ts` - æ’­æ”¾å™¨æ ¸å¿ƒé€»è¾‘
   - `js/api.ts` - API è¯·æ±‚å¤„ç†
   - `js/indexed-db.ts` - æ•°æ®åº“æ“ä½œ

2. **ä¸­ä¼˜å…ˆçº§** (é‡è¦åŠŸèƒ½)
   - `js/ui.ts` - UI æ¸²æŸ“å’Œäº¤äº’
   - `js/playlist.ts` - æ’­æ”¾åˆ—è¡¨ç®¡ç†
   - `js/storage-adapter.ts` - å­˜å‚¨é€‚é…å™¨

3. **ä½ä¼˜å…ˆçº§** (è¾…åŠ©åŠŸèƒ½)
   - `js/theme-manager.ts` - ä¸»é¢˜ç®¡ç†
   - `js/search-history.ts` - æœç´¢å†å²
   - `js/image-lazy-load.ts` - å›¾ç‰‡æ‡’åŠ è½½

#### 4. é›†æˆæµ‹è¯•
åˆ›å»º `tests/integration/` ç›®å½•ï¼Œæµ‹è¯•æ¨¡å—é—´äº¤äº’ï¼š
- æ’­æ”¾å™¨ä¸ UI çš„é›†æˆ
- API ä¸å­˜å‚¨çš„é›†æˆ
- æ’­æ”¾å™¨ä¸æ’­æ”¾åˆ—è¡¨çš„é›†æˆ

### é•¿æœŸç›®æ ‡ï¼ˆ1å‘¨ï¼‰

#### 5. E2E æµ‹è¯•
ä½¿ç”¨å·²é…ç½®çš„ Playwrightï¼š
```bash
npm run test:e2e
```

æµ‹è¯•åœºæ™¯ï¼š
- æœç´¢æ­Œæ›²å¹¶æ’­æ”¾
- æ·»åŠ åˆ°æ”¶è—
- åˆ›å»ºæ’­æ”¾åˆ—è¡¨
- ä¸‹è½½æ­Œæ›²
- åˆ‡æ¢ä¸»é¢˜

#### 6. è¾¾åˆ°80%+è¦†ç›–ç‡ç›®æ ‡
**å½“å‰è¦†ç›–ç‡**: 0% (æµ‹è¯•æœªè¿è¡Œ)

**ç›®æ ‡è¦†ç›–ç‡**:
- æ•´ä½“: 80%+
- æ ¸å¿ƒæ¨¡å— (player, api, ui): 90%+
- å·¥å…·å‡½æ•°: 95%+
- é…ç½®æ–‡ä»¶: 100%

## æµ‹è¯•ç”¨ä¾‹ç¼–å†™æŒ‡å—

### æµ‹è¯•æ–‡ä»¶ç»“æ„
```typescript
import { describe, test, expect, beforeEach, afterEach, vi } from 'vitest';
import { functionToTest } from '../js/module';

describe('æ¨¡å—å - åŠŸèƒ½åˆ†ç±»', () => {
  beforeEach(() => {
    // æµ‹è¯•å‰å‡†å¤‡
  });

  afterEach(() => {
    // æµ‹è¯•åæ¸…ç†
  });

  test('åº”è¯¥åšä»€ä¹ˆ', () => {
    // Arrange - å‡†å¤‡
    const input = 'test';
    
    // Act - æ‰§è¡Œ
    const result = functionToTest(input);
    
    // Assert - æ–­è¨€
    expect(result).toBe('expected');
  });
});
```

### Mock æŒ‡å—

#### 1. Mock å®šæ—¶å™¨
```typescript
beforeEach(() => {
  vi.useFakeTimers();
});

afterEach(() => {
  vi.restoreAllMocks();
});

test('æµ‹è¯•é˜²æŠ–', () => {
  const fn = vi.fn();
  const debouncedFn = debounce(fn, 100);
  
  debouncedFn();
  vi.advanceTimersByTime(100);
  
  expect(fn).toHaveBeenCalledTimes(1);
});
```

#### 2. Mock API è¯·æ±‚
```typescript
test('åº”è¯¥è·å–æ­Œæ›²ä¿¡æ¯', async () => {
  const mockFetch = vi.fn().mockResolvedValue({
    ok: true,
    json: async () => ({ id: '1', name: 'æ­Œæ›²å' }),
  });
  
  global.fetch = mockFetch;
  
  const result = await getSongInfo('1');
  expect(result.name).toBe('æ­Œæ›²å');
});
```

#### 3. Mock LocalStorage
```typescript
beforeEach(() => {
  localStorage.clear();
});

test('åº”è¯¥ä¿å­˜æ•°æ®', () => {
  storage.set('key', { data: 'value' });
  const result = storage.get('key', {});
  expect(result).toEqual({ data: 'value' });
});
```

#### 4. Mock DOM å…ƒç´ 
```typescript
test('åº”è¯¥æ›´æ–° DOM', () => {
  document.body.innerHTML = '<div id="test"></div>';
  const element = document.getElementById('test');
  
  updateElement(element, 'new text');
  
  expect(element?.textContent).toBe('new text');
});
```

## æµ‹è¯•å‘½ä»¤

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
npm test

# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
npm run test:coverage

# ä»¥ UI æ¨¡å¼è¿è¡Œæµ‹è¯•
npm run test:ui

# è¿è¡Œ E2E æµ‹è¯•
npm run test:e2e

# è¿è¡Œ E2E æµ‹è¯•ï¼ˆUI æ¨¡å¼ï¼‰
npm run test:e2e:ui
```

## è¦†ç›–ç‡æŠ¥å‘Šä½ç½®

ç”Ÿæˆçš„è¦†ç›–ç‡æŠ¥å‘Šå°†ä¿å­˜åœ¨ï¼š
- HTML æŠ¥å‘Š: `coverage/index.html`
- JSON æŠ¥å‘Š: `coverage/coverage-final.json`
- LCOV æŠ¥å‘Š: `coverage/lcov.info`

## æŒç»­é›†æˆå»ºè®®

### GitHub Actions é…ç½®ç¤ºä¾‹
```yaml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm ci
      - run: npm test
      - run: npm run test:coverage
      - uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
```

## æ€»ç»“

è™½ç„¶å½“å‰æµ‹è¯•æ¡†æ¶é…ç½®é‡åˆ°æŠ€æœ¯é—®é¢˜ï¼Œä½†æµ‹è¯•ç”¨ä¾‹å·²ç»ç¼–å†™å®Œæˆï¼Œæµ‹è¯•ç­–ç•¥å·²ç»åˆ¶å®šã€‚ä¸€æ—¦è§£å†³é…ç½®é—®é¢˜ï¼Œå¯ä»¥ç«‹å³å¼€å§‹æ‰§è¡Œæµ‹è¯•å¹¶è¾¾åˆ°80%+çš„è¦†ç›–ç‡ç›®æ ‡ã€‚

**å»ºè®®ä¼˜å…ˆçº§**:
1. ğŸ”¥ è§£å†³ Vitest é…ç½®é—®é¢˜ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
2. âœ… å®Œæˆ utils å’Œ config æµ‹è¯•ï¼ˆå·²å®Œæˆï¼‰
3. ğŸ“ ç¼–å†™ playerã€apiã€ui æ¨¡å—æµ‹è¯•
4. ğŸ¯ è¾¾åˆ°80%+è¦†ç›–ç‡ç›®æ ‡
5. ğŸš€ é›†æˆåˆ° CI/CD æµç¨‹